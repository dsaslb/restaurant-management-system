{% extends "base.html" %}

{% block title %}ê³„ì•½ì„œ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>ğŸ“„ ê³„ì•½ ëª©ë¡</h2>
    
    <!-- ê²€ìƒ‰ í¼ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <form method="GET" class="form-inline">
                <div class="form-group mx-sm-3">
                    <input type="text" name="search" class="form-control" placeholder="ì§ì›ëª… ê²€ìƒ‰" value="{{ search }}">
                </div>
                <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
            </form>
        </div>
    </div>
    
    <!-- ê³„ì•½ ëª©ë¡ -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì§ì›ëª…</th>
                                    <th>ì§ì±…</th>
                                    <th>ê³„ì•½ ì‹œì‘ì¼</th>
                                    <th>ê³„ì•½ ì¢…ë£Œì¼</th>
                                    <th>ê¸‰ì—¬ ìœ í˜•</th>
                                    <th>ê¸‰ì—¬</th>
                                    <th>ì„œëª… ì—¬ë¶€</th>
                                    <th>ê³„ì•½ì„œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contract in contracts %}
                                <tr>
                                    <td>{{ contract.employee.user.name }}</td>
                                    <td>{{ contract.employee.position }}</td>
                                    <td>{{ contract.start_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ contract.end_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ contract.pay_type }}</td>
                                    <td>{{ "{:,}".format(contract.wage) }}ì›</td>
                                    <td>
                                        {% if contract.signed %}
                                            <span class="badge badge-success">ì„œëª…ì™„ë£Œ</span>
                                        {% else %}
                                            <span class="badge badge-warning">ë¯¸ì„œëª…</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if contract.pdf_path %}
                                            <a href="/{{ contract.pdf_path }}" target="_blank" class="btn btn-sm btn-info">
                                                ì—´ê¸°
                                            </a>
                                        {% else %}
                                            <span class="text-muted">ì—†ìŒ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if contract.end_date <= now + timedelta(days=7) %}
                                            <form method="POST" action="{{ url_for('contract.renew_contract', contract_id=contract.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    ê°±ì‹ 
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê³„ì•½ì„œ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editContractModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê³„ì•½ì„œ ìˆ˜ì •</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editContractForm">
                    <input type="hidden" id="contractId">
                    <div class="form-group">
                        <label>ê³„ì•½ ì‹œì‘ì¼</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>ê³„ì•½ ì¢…ë£Œì¼</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <div class="form-group">
                        <label>ê¸‰ì—¬ í˜•íƒœ</label>
                        <select class="form-control" id="payType" required>
                            <option value="ì‹œê¸‰ì œ">ì‹œê¸‰ì œ</option>
                            <option value="ì›”ê¸‰ì œ">ì›”ê¸‰ì œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê¸‰ì—¬</label>
                        <input type="number" class="form-control" id="wage" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="saveContractBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const perPage = 10;

// ê³„ì•½ì„œ ëª©ë¡ ë¡œë“œ
function loadContracts(page = 1) {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    
    fetch(`/api/contracts?page=${page}&per_page=${perPage}&search=${search}&status=${status}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderContracts(data.data.contracts);
                renderPagination(data.data);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('ê³„ì•½ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê³„ì•½ì„œ ëª©ë¡ ë Œë”ë§
function renderContracts(contracts) {
    const tbody = document.getElementById('contractList');
    tbody.innerHTML = '';
    
    contracts.forEach(contract => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${contract.employee_name}</td>
            <td>${contract.position}</td>
            <td>${contract.start_date} ~ ${contract.end_date}</td>
            <td>${contract.pay_type} ${contract.wage.toLocaleString()}ì›</td>
            <td>
                <span class="badge badge-${getStatusBadgeClass(contract)}">
                    ${getStatusText(contract)}
                </span>
            </td>
            <td>${contract.signed_at || '-'}</td>
            <td>
                <div class="btn-group">
                    <a href="/contract/${contract.employee_id}" class="btn btn-sm btn-info">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button class="btn btn-sm btn-primary" onclick="editContract(${JSON.stringify(contract).replace(/"/g, '&quot;')})">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${data.current_page === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadContracts(${data.current_page - 1})">
            <i class="fas fa-chevron-left"></i>
        </a>
    `;
    pagination.appendChild(prevLi);
    
    // í˜ì´ì§€ ë²ˆí˜¸
    for (let i = 1; i <= data.pages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === data.current_page ? 'active' : ''}`;
        li.innerHTML = `
            <a class="page-link" href="#" onclick="loadContracts(${i})">${i}</a>
        `;
        pagination.appendChild(li);
    }
    
    // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${data.current_page === data.pages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadContracts(${data.current_page + 1})">
            <i class="fas fa-chevron-right"></i>
        </a>
    `;
    pagination.appendChild(nextLi);
}

// ìƒíƒœ ë±ƒì§€ í´ë˜ìŠ¤ ë°˜í™˜
function getStatusBadgeClass(contract) {
    const today = new Date();
    const endDate = new Date(contract.end_date);
    
    if (!contract.signed) return 'warning';
    if (endDate < today) return 'danger';
    return 'success';
}

// ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
function getStatusText(contract) {
    const today = new Date();
    const endDate = new Date(contract.end_date);
    
    if (!contract.signed) return 'ë¯¸ì„œëª…';
    if (endDate < today) return 'ë§Œë£Œë¨';
    return 'ì§„í–‰ì¤‘';
}

// ê³„ì•½ì„œ ìˆ˜ì •
function editContract(contract) {
    document.getElementById('contractId').value = contract.id;
    document.getElementById('startDate').value = contract.start_date;
    document.getElementById('endDate').value = contract.end_date;
    document.getElementById('payType').value = contract.pay_type;
    document.getElementById('wage').value = contract.wage;
    
    $('#editContractModal').modal('show');
}

// ê³„ì•½ì„œ ì €ì¥
document.getElementById('saveContractBtn').addEventListener('click', function() {
    const contractId = document.getElementById('contractId').value;
    const data = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        pay_type: document.getElementById('payType').value,
        wage: parseInt(document.getElementById('wage').value)
    };
    
    fetch(`/api/contract/${contractId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            $('#editContractModal').modal('hide');
            loadContracts(currentPage);
            showSuccess('ê³„ì•½ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('ê³„ì•½ì„œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.getElementById('searchBtn').addEventListener('click', () => loadContracts(1));
document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loadContracts(1);
});
document.getElementById('statusFilter').addEventListener('change', () => loadContracts(1));
document.getElementById('refreshBtn').addEventListener('click', () => loadContracts(currentPage));

// ì´ˆê¸° ë¡œë“œ
loadContracts();
</script>
{% endblock %} 